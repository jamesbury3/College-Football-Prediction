---
title: "Predictions"
author: "James Bury"
date: "11/12/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(randomForest)
library(glmnet)
```

```{r}
df = read.csv("DF_FINAL_CONFERENCES_DIFFS.csv")
```

```{r}
head(df)
```

# Predicting Result

# Make prediction set
```{r}
set.seed(1234)

train = list()
test = list()
dfs = list()

for(l in 1:length(levels(df$Conference))) {
  df.prediction = df %>%
    filter(Conference == levels(df$Conference)[l]) %>%
    select(
      -School,
      -Opponent,
      -Date,
      -Season,
      -Score,
      -OppScore,
      -Total,
      -Spread,
      -Conference,
      -SeasonRanking,
      -OppSeasonRanking,
      -Team,
      -Nickname,
      -City,
      -State,
      -OppNickname,
      -OppCity,
      -OppState,
      -OppConference)

  df.prediction$Outcome = ifelse(df.prediction$Outcome == "W", 1, 0)
  df.prediction$Season.Type = ifelse(df.prediction$Season.Type == "Regular", 1, 0)
  
  curr_train = sample_n(df.prediction, size = 0.7 * nrow(df.prediction), replace = FALSE)
  train[[l]] = data.frame(curr_train)
  test[[l]] = data.frame(anti_join(df.prediction, curr_train))
}


```

# Logistic Regression
```{r}
set.seed(1234)

accuracies = data.frame(Conference="", Accuracy=0)
for(l in 1:length(train)) {
  if(length(test[[l]]) > 20) {
    model = glm(Outcome~., data = train[[l]], family = "binomial")
    predictions = suppressWarnings(predict.glm(model, test[[l]], type = "response"))
    predictions = ifelse(predictions >= 0.5, 1, 0)
    print(paste("Logistic Regression Accuracy on 30% test",sum(ifelse(predictions == test[[l]]$Outcome, 1, 0)) / nrow(test[[l]])))
    accuracies = rbind(accuracies, data.frame(Conference=levels(df$Conference)[l], Accuracy=sum(ifelse(predictions == test[[l]]$Outcome, 1, 0)) / nrow(test[[l]])))
  }
}
accuracies = accuracies[-1,]
accuracies

```

# Predicting Spread

# Make prediction set
```{r}
set.seed(1234)

df.prediction = df %>%
  select(
    -School,
    -Opponent,
    -Date,
    -Season,
    -Score,
    -OppScore,
    -Total,
    -Outcome,
    -SeasonRanking,
    -OppSeasonRanking,
    -Team,
    -Nickname,
    -City,
    -State,
    -Conference,
    -OppNickname,
    -OppCity,
    -OppState,
    -OppConference)

df.prediction$Season.Type = ifelse(df.prediction$Season.Type == "Regular", 1, 0)

train = sample_n(df.prediction, size = 0.7 * nrow(df.prediction), replace = FALSE)
test = anti_join(df.prediction, train)
```

# Linear Regression
```{r}
set.seed(1234)
model = lm(Spread~., data = train)
summary(model)

predictions = predict.lm(model, newdata = test, type = "response")
MAE = sum(abs(test$Spread - predictions)) / nrow(test)
MAE
mean(test$Spread)
hist(test$Spread)
```

# Lasso Regression
```{r}
train.matrix = model.matrix(Spread~., data = train)
test.matrix = model.matrix(Spread~., data = test)
set.seed(1234)

model = cv.glmnet(train.matrix, train$Spread, family = "gaussian", alpha = 1, nfolds = 5)
coef(model)

predictions = predict.cv.glmnet(model, newx = test.matrix, type = "response")
MAE = sum(abs(test$Spread - predictions)) / nrow(test)
MAE
mean(test$Spread)
```


# Predicting Total

# Make prediction set
```{r}
set.seed(1234)

df.prediction = df %>%
  select(
    -School,
    -Opponent,
    -Date,
    -Season,
    -Score,
    -OppScore,
    -Outcome,
    -Spread,
    -SeasonRanking,
    -OppSeasonRanking,
    -Team,
    -Nickname,
    -City,
    -State,
    -Conference,
    -OppNickname,
    -OppCity,
    -OppState,
    -OppConference)

df.prediction$Season.Type = ifelse(df.prediction$Season.Type == "Regular", 1, 0)

train = sample_n(df.prediction, size = 0.7 * nrow(df.prediction), replace = FALSE)
test = anti_join(df.prediction, train)
```

# Linear Model
```{r}
set.seed(1234)
model = lm(Total~., data = train)
summary(model)

predictions = predict.lm(model, newdata = test, type = "response")
MAE = sum(abs(test$Total - predictions)) / nrow(test)
MAE
```

# Lasso Regression
```{r}
train.matrix = model.matrix(Total~., data = train)
test.matrix = model.matrix(Total~., data = test)
set.seed(1234)

model = cv.glmnet(train.matrix, train$Total, family = "gaussian", alpha = 0, nfolds = 5)
coef(model)

predictions = predict.cv.glmnet(model, newx = test.matrix, type = "response")
MAE = sum(abs(test$Total - predictions)) / nrow(test)
MAE
mean(test$Total)
```

